---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# jpgrid <a href="https://uchidamizuki.github.io/jpgrid/"><img src="man/figures/logo.png" align="right" height="139" /></a>

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/jpgrid)](https://CRAN.R-project.org/package=jpgrid)
<!-- badges: end -->

_[The English version of the README is here.](https://github.com/UchidaMizuki/jpgrid/blob/main/README.en.md)_

jpgridは，日本産業規格JIS X 0410
[地域メッシュコード](https://www.jisc.go.jp/app/jis/general/GnrJISNumberNameSearchList?show&jisStdNo=X0410)
（Grid Square Code）で定められた基準地域メッシュ (1次～3次) と分割地域メッシュ，および3次メッシュ1/10細分区画を利用するためのRパッケージです．
地域メッシュコードは，経度・緯度に基づいて，日本全国の地域に設定された正方形に近い地域区分です．
地域メッシュコードの詳細については，[統計局ページ](https://www.stat.go.jp/data/mesh/pdf/gaiyo1.pdf)を確認してください．

地域メッシュコードの概要を以下に示します．jpgridでは，`grid_80km`のように，メッシュの一片の長さで各地域メッシュコードを区別します．

```{r,echo=FALSE}
df <- tibble::tibble(`名称` = c("第1次地域区画 (1次メッシュ)", "第2次地域区画 (2次メッシュ)", "第3次地域区画 (3次メッシュ)", "2分の1地域メッシュ", "4分の1地域メッシュ", "8分の1地域メッシュ", "3次メッシュ1/10細分区画"),
                     `一片の長さ` = c("約80km", "約10km", "約1km", "約500m", "約250m", "約125m", "約100m"),
                     `桁数` = c(4, 6, 8, 9, 10, 11, 10))
knitr::kable(df)
```

jpgridは，Rパッケージの[jpmesh](https://github.com/uribo/jpmesh)より高速な処理を可能とするために開発されたものです．
jpgridとjpmeshとの主な違いとして以下が挙げられます．

1. メッシュコードに，メッシュサイズ (`grid_80km`など) が明示的に与えられます．
2. 国土にかからない (海上の) メッシュにも対応しています．
3. n次隣接メッシュの抽出・メッシュ間の (線分) 経路上のメッシュ抽出や距離算出などの複雑な処理が可能です．

## インストール方法

CRANからインストールが可能です．

``` r
install.packages("jpgrid")
```

開発版はGitHubからインストールしてください．

``` r
# install.packages("devtools")
devtools::install_github("UchidaMizuki/jpgrid")
```
## 使用方法

```{r,message=FALSE,warning=FALSE}
library(jpgrid)

library(tibble)
library(dplyr)
library(ggplot2)

JGD2011 <- 6668
```

### 文字列・数値からの地域メッシュコードの生成

文字列・数値から地域メッシュコードを生成するためには`grid_parse()`を使用します．

- `grid_size = "80km"`のようにメッシュサイズを指定します．
  - `grid_size = NULL`の場合はメッシュサイズが自動的に決定されます．
- デフォルト（`strict = TRUE`）では，メッシュコードの桁数が所定の桁数であることを要求します．

```{r}
x <- c("53394526313", "5339358633", "533945764", "53394611", "523503", "5339", NA)

grid_parse(x, grid_size = "80km")
grid_parse(x, grid_size = "125m")
grid_parse(x)

grid_parse(x, "80km",
           strict = FALSE)
grid_parse(x, "125m",
           strict = FALSE)
grid_parse(x, 
           strict = FALSE)
```

### 地域メッシュコードのサイズの変換

地域メッシュコードのメッシュサイズを粗くする場合には，`grid_convert()`を使用します．
また，`grid_subdivide()`により，地域メッシュコードの細分化を行います．

- `grid_subdivide()`は，元のメッシュに含まれるメッシュを要素にもつリストを出力します．
- 500 mメッシュ・100 mメッシュ間の変換に対応しています．

```{r}
grid_500m <- grid_parse("533945764", "500m")

grid_convert(grid_500m, "1km")

grid_100m <- grid_subdivide(grid_500m, "100m")
grid_100m

tibble(grid_100m = grid_100m[[1]]) |> 
  grid_as_sf() |>  
  ggplot() +
  geom_sf() +
  geom_sf_text(aes(label = as.character(grid_100m)))
```

### ジオメトリの地域メッシュコードへの変換

`grid_from_geom()`により，`sf`オブジェクトを地域メッシュコードに変換することができます．
また，`grid_as_sf()`により地域メッシュ（`grid`クラス）を含むデータを`sf`オブジェクトに変換できます．

```{r}
geom_chiba <- rnaturalearth::ne_states(country = "japan",
                                       returnclass = "sf") |> 
  filter(name == "Chiba")
grid_chiba <- grid_from_geom(geom_chiba, "10km") |> 
  first() |> 
  grid_as_sf(crs = sf::st_crs(geom_chiba))

grid_chiba |> 
  ggplot() +
  geom_sf(data = geom_chiba) +
  geom_sf(fill = "transparent") +
  geom_sf_text(aes(label = as.character(grid)),
               size = 2)
```

### 経度・緯度から地域メッシュコードへの変換

`grid_from_coords()`は，経度・緯度を地域メッシュコードに変換します．

```{r}
tibble(X = c(139.7008, 135.4375), # 経度
       Y = c(35.68906, 34.70833)) |>  # 緯度
  mutate(grid_100m = grid_from_coords(X, Y, "100m"),
         grid_125m = grid_from_coords(X, Y, "125m")) |> 
  knitr::kable()
```

### 地域メッシュコードから経度・緯度への変換

`grid_to_coords()`は，地域メッシュコードを経度・緯度に変換します．

```{r}
tibble(grid = grid_100m(c("5339452660", "5235034590"))) |> 
  mutate(grid_to_coords(grid)) |> 
  knitr::kable()
```

### 隣接メッシュの算出

`grid_neighbor()`関数は，隣接するメッシュを算出します．

- `n`を指定することでn次隣接メッシュの算出が可能
- `moore = FALSE`でノイマン近傍での算出が可能

```{r}
neighbor <- grid_parse("644142", "10km") |> 
  grid_neighbor(n = c(0:2),
                simplify = FALSE)

neighbor[[1]] |> 
  grid_as_sf() |> 
  
  ggplot(aes(fill = as.factor(n))) +
  geom_sf() +
  geom_sf_text(aes(label = as.character(grid_neighbor)))
```

```{r}
neighbor_neumann <- grid_parse("644142", "10km") |> 
  grid_neighbor(n = c(0:2),
                simplify = F,
                moore = F)

neighbor_neumann[[1]] |> 
  grid_as_sf() |> 
  ggplot(aes(fill = as.factor(n))) +
  geom_sf() +
  geom_sf_text(aes(label = as.character(grid_neighbor)))
```

### メッシュ間の線分描画

`grid_line()`関数により，メッシュ間の線分上に存在するメッシュを抽出します．

```{r}
grid_from <- grid_parse(c("6441", "5339"), "80km")
grid_to <- grid_parse(c("5237", "5235"), "80km")

line <- grid_line(grid_from, grid_to)

tibble::tibble(grid = line[[1]]) |> 
  grid_as_sf() |> 
  ggplot() +
  geom_sf() +
  geom_sf_text(aes(label = as.character(grid)))
```

メッシュの`list`を与えることで複数メッシュを通る場合に対応可能です．

- `close = TRUE`で線分を閉じます．
- `skip_na = TRUE`で`NA`をスキップします．

```{r}
grid_1 <- grid_parse(c("6441", "5339", NA, "5250"), "80km")
grid_2 <- grid_parse(c("6439", "5211", "4013", "6635"), "80km")

line <- grid_line(list(grid_1, grid_2), 
                  close = TRUE,
                  skip_na = TRUE)

tibble::tibble(grid = line[[1]]) |> 
  grid_as_sf() |> 
  ggplot() +
  geom_sf() +
  geom_sf_text(aes(label = as.character(grid)))
```

### メッシュ間距離の算出

`grid_distance()`関数は，メッシュ間距離（大円距離）を算出します．

- `grid_line()`と同様にメッシュの`list`で経路距離を算出可能です．

```{r}
grid_from <- grid_parse(c("6441", "5339"), "80km")
grid_to <- grid_parse(c("5237", "5235"), "80km")

distance <- grid_distance(grid_from, grid_to)

print(distance)
```

### その他
- `grid_move()`関数により，東西南北方向の地域メッシュコードを算出可能です．
- 80kmメッシュの桁が負や三桁以上になる範囲外のメッシュについては，当該コードを`<-1>`，`<123>`のように表示し，既存メッシュと明確に区別できるようにしています．

## jpmeshとの処理速度の比較

本パッケージのメッシュ・緯度経度間の変換速度は，jpmeshパッケージと比べて数十～数百倍ほど高速です．

```{r,echo=FALSE,message=FALSE}
set.seed(1234)
X <- runif(1e1, 139, 140)
Y <- runif(1e1, 39, 40)

microbenchmark::microbenchmark(`jpgrid::grid_from_coords()` = grid_from_coords(X, Y, "1km"),
                               `jpmesh::coords_to_mesh()` = jpmesh::coords_to_mesh(X, Y,
                                                                                   mesh_size = 1),
                               setup = set.seed(1234)) |> 
  autoplot()
```

```{r,echo=FALSE,message=FALSE}
set.seed(1234)
X <- runif(1e1, 139, 140)
Y <- runif(1e1, 39, 40)
grid_jpgrid <- grid_from_coords(X, Y, "1km")
mesh_jpmesh <- jpmesh::coords_to_mesh(X, Y, 
                                      mesh_size = 1)

microbenchmark::microbenchmark(`jpgrid::grid_to_coords()` = grid_to_coords(grid_jpgrid),
                               `jpmesh::mesh_to_coords()` = jpmesh::mesh_to_coords(mesh_jpmesh),
                               setup = set.seed(1234)) |> 
  autoplot()
```
