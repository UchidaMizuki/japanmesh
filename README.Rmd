---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# japanmesh

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/japanmesh)](https://CRAN.R-project.org/package=japanmesh)
<!-- badges: end -->

README is currently only available in Japanese.

japanmeshは，日本で用いられる「[地域メッシュ](https://ja.wikipedia.org/wiki/%E5%9C%B0%E5%9F%9F%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5)」を利用するためのRパッケージです．
80 kmメッシュ (1次メッシュ) から100 mメッシュ (3次メッシュ1/10細分区画) までに対応しています．
地域メッシュの詳細については，[統計局ページ](https://www.stat.go.jp/data/mesh/pdf/gaiyo1.pdf)を確認してください．

japanmeshは，[jpmesh](https://github.com/uribo/jpmesh)より高速な処理を可能とするために開発されたものです．
japanmeshのjpmeshとの主な違いとして以下が挙げられます．

1. メッシュコードに，メッシュサイズ (`mesh_80km`など) が明示的に与えられます．
2. 国土にかからない (海上の) メッシュにも対応しています．
3. n次隣接メッシュの抽出・メッシュ間の (線分) 経路上のメッシュ抽出や距離算出などの複雑な処理が可能です．

## インストール方法

CRANからインストールが可能です．

``` r
install.packages("japanmesh")
```

開発版はGitHubからインストールしてください．

``` r
# install.packages("devtools")
devtools::install_github("UchidaMizuki/japanmesh")
```
## 使用方法

```{r,message=FALSE,warning=FALSE}
library(japanmesh)

library(tibble)
library(dplyr)
library(ggplot2)
```

### 文字列・数値からの地域メッシュの生成

文字列・数値から地域メッシュを生成するためには`mesh_80km()`，`mesh_auto()`などの関数を使用します．

- `mesh_auto()`関数はメッシュサイズを自動的に決定します．
- デフォルト（`strict = T`）では，メッシュコードの桁数が所定の桁数であることを要求します．

```{r}
library(japanmesh)

x <- c("53394526313", "5339358633", "533945764", "53394611", "523503", "5339", NA)

mesh_80km(x)
mesh_125m(x)
mesh_auto(x)

mesh_80km(x, strict = F)
mesh_125m(x, strict = F)
mesh_auto(x, strict = F)
```

### 地域メッシュのサイズの変換

地域メッシュのメッシュサイズを粗くする場合には，`mesh_80km()`などの関数を使用します．
また，`mesh_subdivide()`関数により，地域メッシュの細分化を行います．

- `mesh_subdivide()`は元のメッシュに含まれるメッシュを要素にもつリストを出力します．
- 500 mメッシュ・100 mメッシュ間の変換に対応しています．

```{r}
mesh500m <- mesh_500m("533945764")

mesh_1km(mesh500m)

mesh100m <- mesh_subdivide(mesh500m,
                           size = "100m")
mesh100m

tibble(mesh100m = mesh100m[[1]]) %>% 
  mutate(polygon = mesh_to_polygon(mesh100m)) %>% 
  sf::st_as_sf() %>%
  
  ggplot() +
  geom_sf() +
  geom_sf_text(aes(label = mesh100m))
```

### 経度・緯度から地域メッシュへの変換

`XY_to_mesh()`関数は，経度・緯度を地域メッシュに変換します．

```{r}
tibble(X = c(139.7008, 135.4375), # 経度
       Y = c(35.68906, 34.70833)) %>% # 緯度
  mutate(mesh100m = XY_to_mesh(X, Y, size = "100m"),
         mesh125m = XY_to_mesh(X, Y, size = "125m")) %>% 
  knitr::kable()
```

### 地域メッシュから経度・緯度への変換

`mesh_to_XY()`関数は，地域メッシュを経度・緯度に変換します．

```{r}
tibble(mesh = c("5339452660", "5235034590")) %>% 
  mutate(mesh %>% 
           mesh_100m() %>% 
           mesh_to_XY()) %>% 
  knitr::kable()
```

### 隣接メッシュの算出

`mesh_neighbor()`関数は，隣接するメッシュを算出します．

- `n`を指定することでn次隣接メッシュの算出が可能
- `moore = F`でノイマン近傍での算出が可能

```{r}
neighbor <- mesh_10km("644142") %>% 
  mesh_neighbor(n = c(0:2),
                simplify = F)

neighbor[[1]] %>% 
  mutate(geometry = mesh_to_polygon(mesh_neighbor)) %>% 
  sf::st_as_sf() %>% 
  
  ggplot(aes(fill = as.factor(n))) +
  geom_sf() +
  geom_sf_text(aes(label = mesh_neighbor))
```

```{r}
neighbor_neumann <- mesh_10km("644142") %>% 
  mesh_neighbor(n = c(0:2),
                simplify = F,
                moore = F)

neighbor_neumann[[1]] %>% 
  mutate(geometry = mesh_to_polygon(mesh_neighbor)) %>% 
  sf::st_as_sf() %>% 
  
  ggplot(aes(fill = as.factor(n))) +
  geom_sf() +
  geom_sf_text(aes(label = mesh_neighbor))
```

### メッシュ間の線分描画

`mesh_line()`関数により，メッシュ間の線分上に存在するメッシュを抽出します．

```{r}
mesh_from <- mesh_80km(c("6441", "5339"))
mesh_to <- mesh_80km(c("5237", "5235"))

line <- mesh_line(mesh_from, mesh_to)

print(line)
plot(line[[1]])
```

メッシュの`list`を与えることで複数メッシュを通る場合に対応可能です．

- `close = T`で線分を閉じます．
- `skip_na = T`で`NA`をスキップします．

```{r}
mesh_1 <- mesh_80km(c("6441", "5339", NA, "5250"))
mesh_2 <- mesh_80km(c("6439", "5211", "4013", "6635"))

line <- mesh_line(list(mesh_1, mesh_2), 
                  close = T,
                  skip_na = T)

print(line)
plot(line[[1]])
```

### メッシュ間距離の算出

`mesh_distance()`関数は，メッシュ間距離（大円距離）を算出します．

- `mesh_line()`と同様にメッシュの`list`で経路距離を算出可能です．

```{r}
mesh_from <- mesh_80km(c("6441", "5339"))
mesh_to <- mesh_80km(c("5237", "5235"))

distance <- mesh_distance(mesh_from, mesh_to)

print(distance)
```

### その他
- `mesh_move()`関数により，東西南北方向の地域メッシュを算出可能です．
- `mesh_to_polygon()`関数および`mesh_to_point()`関数により`sfc`ジオメトリを出力可能です．
- 80kmメッシュの桁が負や三桁以上になる範囲外のメッシュについては，当該コードを`<-1>`，`<123>`のように表示し，既存メッシュと明確に区別できるようにしています．

## jpmeshとの処理速度の比較

本パッケージのメッシュ・緯度経度間の変換速度は，`jpmesh`パッケージと比べて数百倍ほど高速です．

```{r,echo=FALSE}
set.seed(1234)
X <- runif(1e1, 139, 140)
Y <- runif(1e1, 39, 40)

microbenchmark::microbenchmark(`japanmesh::XY_to_mesh()` = XY_to_mesh(X, Y,
                                                                    size = "1km"),
                               `jpmesh::coords_to_mesh()` = jpmesh::coords_to_mesh(X, Y,
                                                                                 mesh_size = 1)) %>% 
  autoplot()
```

```{r,echo=FALSE}
set.seed(1234)
X <- runif(1e1, 139, 140)
Y <- runif(1e1, 39, 40)
mesh_japanmesh <- XY_to_mesh(X, Y,
                             size = "1km")
mesh_jpmesh <- jpmesh::coords_to_mesh(X, Y, 
                                      mesh_size = 1)

microbenchmark::microbenchmark(`japanmesh::mesh_to_XY()` = mesh_to_XY(mesh_japanmesh),
                               `jpmesh::mesh_to_coords()` = jpmesh::mesh_to_coords(mesh_jpmesh)) %>% 
  autoplot()
```
