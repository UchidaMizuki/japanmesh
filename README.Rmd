---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

## japanmesh

<<<<<<< Updated upstream
<!-- badges: start -->
<!-- badges: end -->
=======
README is currently only available in Japanese.
>>>>>>> Stashed changes

地域メッシュと経度・緯度との変換や異なるサイズの地域メッシュ間の変換などを行うためのRパッケージです．

### インストール方法

<<<<<<< Updated upstream
<!-- You can install the released version of japanmesh from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("japanmesh") -->
<!-- ``` -->

<!-- And the development version from [GitHub](https://github.com/) with: -->

CRANには登録されていないためGitHubからインストールしてください．
=======
``` r
install.packages("japanmesh")
```

開発版はGitHubからインストールしてください．
>>>>>>> Stashed changes

``` r
# install.packages("devtools")
devtools::install_github("UchidaMizuki/japanmesh")
```
### 使用方法

```{r,message=FALSE,warning=FALSE}
library(japanmesh)
library(tibble)
library(dplyr)
```

#### 文字列・数値からの地域メッシュの生成

文字列・数値から地域メッシュを生成するためには`mesh_***m()`，`mesh_auto()`関数を使用します．

- `mesh_auto()`関数はメッシュサイズを自動的に決定します．
- デフォルト（`strict = T`）では，メッシュコードの桁数が所定の桁数であることを要求します．

```{r}
library(japanmesh)

x <- c("53394526313", "5339358633", "533945764", "53394611", "523503", "5339", NA)

mesh_80km(x)
mesh_125m(x)
mesh_auto(x)

mesh_80km(x, strict = F)
mesh_125m(x, strict = F)
mesh_auto(x, strict = F)
```

#### 地域メッシュのサイズの変換

`mesh_zoomin()`，`mesh_zoomout()`関数により，地域メッシュのサイズ変換・細分化を行います．

- `mesh_zoomin()`は元のメッシュに含まれるメッシュを要素にもつリストを出力します．
- 100 mメッシュから500 mメッシュへの変換に対応．

```{r}
mesh10km <- mesh_10km(x[1:2],
                      strict = F)

mesh_zoomout(mesh10km, 
             size = "80km")

zoomin <- mesh_zoomin(mesh10km,
                      size = "1km")
print(zoomin)
plot(zoomin[[1]])
```

#### 経度・緯度から地域メッシュへの変換

`XY_to_mesh()`関数は，経度・緯度を地域メッシュに変換します．

```{r}
tibble(X = c(139.7008, 135.4375), # 経度
       Y = c(35.68906, 34.70833)) %>% # 緯度
  mutate(mesh100m = XY_to_mesh(X, Y, size = "100m"),
         mesh125m = XY_to_mesh(X, Y, size = "125m"))
```

#### 地域メッシュから経度・緯度への変換

`mesh_to_XY()`関数は，地域メッシュを経度・緯度に変換します．

```{r}
tibble(mesh = c("5339452660", "5235034590")) %>% 
  mutate(mesh %>% 
           mesh_100m() %>% 
           mesh_to_XY())
```

#### 隣接メッシュの算出

`mesh_neighbor()`関数は，隣接するメッシュを算出します．

- `n`を指定することでn次隣接メッシュの算出が可能
- `moore = F`でノイマン近傍での算出が可能

```{r}
neighbor <- mesh_10km("644142") %>% 
  mesh_neighbor(n = c(2, 5))

print(neighbor)
plot(neighbor[[1]])

neighbor_neumann <- mesh_10km("644142") %>% 
  mesh_neighbor(n = c(2, 5),
                moore = F)

print(neighbor_neumann)
plot(neighbor_neumann[[1]])
```

#### メッシュ間の線分描画

`mesh_line()`関数により，メッシュ間の線分上に存在するメッシュを抽出します．

```{r}
mesh_from <- mesh_80km(c("6441", "5339"))
mesh_to <- mesh_80km(c("5237", "5235"))

line <- mesh_line(mesh_from, mesh_to)

print(line)
plot(line[[1]])
```

メッシュの`list`を与えることで複数メッシュを通る場合に対応可能です．

- `close = T`で線分を閉じます．
- `skip_na = T`で`NA`をスキップします．

```{r}
mesh_1 <- mesh_80km(c("6441", "5339", NA, "5250"))
mesh_2 <- mesh_80km(c("6439", "5211", "4013", "6635"))

line <- mesh_line(list(mesh_1, mesh_2), 
                  close = T,
                  skip_na = T)

print(line)
plot(line[[1]])
```

#### メッシュ間距離の算出

`mesh_distance()`関数は，メッシュ間距離（大円距離）を算出します．

- `mesh_line()`と同様にメッシュの`list`で経路距離を算出可能です．

```{r}
mesh_from <- mesh_80km(c("6441", "5339"))
mesh_to <- mesh_80km(c("5237", "5235"))

distance <- mesh_distance(mesh_from, mesh_to)

print(distance)
```

#### その他
- `mesh_move()`関数により，東西南北方向の地域メッシュを算出可能です．
- `mesh_to_polygon()`関数および`mesh_to_point()`関数により`sfc`ジオメトリを出力可能です．
- 80kmメッシュの桁が負や三桁以上になる範囲外のメッシュについては，当該コードを`<-1>`，`<123>`のように表示し，既存メッシュと明確に区別できるようにしています．

### 他パッケージとの比較

地域メッシュを扱うRパッケージとして，本パッケージの他に`jpmesh`パッケージがあります．
本パッケージの`jpmesh`との優位点として，以下が挙げられます．

- 処理速度が`jpmesh`パッケージより速い場合があります．
- `jpmesh::meshcode()`と違い，`as_mesh()`に`NA`を入力してもエラーを吐きません．

#### `jpmesh`パッケージとの処理速度の比較

以下の例では，本パッケージの計算速度は，`jpmesh`パッケージと比べて数百倍程度，高速です．

```{r}
set.seed(1234)
df <- tibble(X = runif(1e3, 139, 140),
             Y = runif(1e3, 39, 40))

# XY to mesh
# jpmesh
tictoc::tic()
df_jpmesh <- df %>% 
  mutate(mesh = jpmesh::coords_to_mesh(X, Y,
                                       mesh_size = 1))
head(df_jpmesh)
tictoc::toc()

# japanmesh
tictoc::tic()
df_japanmesh <- df %>% 
  mutate(mesh = XY_to_mesh(X, Y, 
                           size = "1km"))
head(df_japanmesh)
tictoc::toc()

# mesh to XY
# jpmesh
tictoc::tic()
df_jpmesh <- df_jpmesh %>% 
  select(mesh) %>% 
  mutate(jpmesh::mesh_to_coords(mesh),
         .keep = "unused")
head(df_jpmesh)
tictoc::toc()

# japanmesh
tictoc::tic()
df_japanmesh <- df_japanmesh %>% 
  select(mesh) %>% 
  mutate(mesh_to_XY(mesh))
head(df_japanmesh)
tictoc::toc()
```
